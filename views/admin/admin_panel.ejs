<!-- views/admin/admin_panel.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
   <link rel="stylesheet" href="/public/stylesheets/admin/admin_panel.css">
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <%- include('../partials/adminSidebar.ejs', { activePage: 'productList' }) %>

        <!-- Page Content -->
        <div id="content">
            <!-- navbar -->
            <%- include('../partials/adminNavbar.ejs') %>

            <div class="container">
                <!-- Add Product button -->
                <a href="/admin/add_product" class="btn btn-success add-product-button ">Add Product</a>

                

                <h2>Product List</h2>
                <div class="table-responsive">
                <table class="table table-striped table-hover">

                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Stock</th>
                            <th>Image</th> 
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% products.forEach(product => { %>
                            <tr>
                                <td><%= product.name %></td>
                                <td><%= product.description %></td>
                                <td><%= product.price %> rs</td>
                                <td>
                                    <% if (product.category && product.category.categoryName) { %>
                                      <%= product.category.categoryName %>
                                    <% } else { %>
                                      Category not available
                                    <% } %>
                                  </td>
                                  <td><%= product.stock || 'Not Available' %></td> <!-- Display quantity or 'Not Available' if not present -->
                                <td> <% product.images.forEach(image => { %>
                                    <img src="/public/uploads/<%= image %>" alt="<%= product.name %>" style="max-width: 100px;">
                                <% }); %></td>
                                <!-- Add Edit button with a link to the edit_product route -->
                                <td>
                                    <a href="/admin/edit_product/<%= product._id %>" class="btn btn-warning">âœŽ</a><br>
                                    <a href="#" class="btn btn-danger apply-delete-btn" data-product-id="<%= product._id %>" data-product-name="<%= product.name %>">ðŸ—‘</a>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
                <!-- Pagination -->
                <nav aria-label="Page navigation example">
                    <ul class="pagination">
                        <% for (let i = 1; i <= totalPages; i++) { %>
                            <li class="page-item <% if (i === page) { %>active<% } %>">
                                <a class="page-link" href="/admin?page=<%= i %>&pageSize=<%= pageSize %>"><%= i %></a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
               
            </div>
            </div>
        </div>
    </div>

    <!-- Include Bootstrap JS and Popper.js (required for Bootstrap dropdowns) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  
    
    <script>
        $("#sidebar-toggle").click(function () {
            $("#sidebar").toggle();
        });

    
        document.querySelectorAll('.apply-delete-btn').forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault(); // Prevent the default behavior of the link

                const productId = event.target.getAttribute('data-product-id');
                const productName = event.target.getAttribute('data-product-name');

                Swal.fire({
                    title: `Are you sure to delete ${productName}?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes',
                    cancelButtonText: 'No',
                    showLoaderOnConfirm: true, // Show loader during async operation
                    preConfirm: () => {
                        // Perform the asynchronous delete operation
                        return fetch(`/admin/delete_product/${productId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(response.statusText);
                                }
                            })
                            .catch(error => {
                                Swal.showValidationMessage(`Error: ${error}`);
                            });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: `${productName} deleted successfully!`,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            // Reload the current page after displaying the success message
                            location.reload();
                        });
                    }
                });
            });
        });
    </script>

</body>
</html>
